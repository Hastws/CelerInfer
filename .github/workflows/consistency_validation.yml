name: MiniMind ä¸€è‡´æ€§éªŒè¯

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'cpp/**'
      - 'python/**'
      - 'models/**'
      - '.github/workflows/consistency_validation.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'cpp/**'
      - 'python/**'
      - 'models/**'

jobs:
  consistency_check:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.12']
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3

    - name: ğŸ è®¾ç½® Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: ğŸ“¦ å®‰è£… Python ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install torch numpy transformers

    - name: ğŸ”§ å®‰è£… C++ ç¼–è¯‘å·¥å…·
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake

    - name: ğŸ—ï¸ ç¼–è¯‘ C++ æ¨ç†å¼•æ“
      run: |
        bash scripts/build_cpp.sh
        if [ ! -f cpp/build/base_line_micro ]; then
          echo "âŒ C++ ç¼–è¯‘å¤±è´¥"
          exit 1
        fi
        echo "âœ… C++ ç¼–è¯‘æˆåŠŸ"

    - name: ğŸ“‚ å‡†å¤‡æ¨¡å‹æ–‡ä»¶
      run: |
        mkdir -p dump_minimind
        echo "ç”Ÿæˆæ¨¡å‹æƒé‡..."
        python python/export/minimind_dumper.py
        if [ ! -f dump_minimind/minimind.json ]; then
          echo "âŒ æ¨¡å‹æƒé‡ç”Ÿæˆå¤±è´¥"
          exit 1
        fi
        echo "âœ… æ¨¡å‹æƒé‡å·²å‡†å¤‡"

    - name: ğŸš€ è¿è¡Œ PyTorch æ¨ç†
      run: |
        python python/inference/minimind_forward.py
        if [ ! -f dump_minimind/logits_torch.npy ]; then
          echo "âŒ PyTorch æ¨ç†å¤±è´¥"
          exit 1
        fi
        echo "âœ… PyTorch æ¨ç†æˆåŠŸ"

    - name: ğŸš€ è¿è¡Œ C++ æ¨ç†
      continue-on-error: true
      run: |
        echo "Running C++ inference..."
        ./cpp/build/base_line_micro dump_minimind/minimind.json dump_minimind || {
          echo "âš ï¸ C++ æ¨ç†å¤±è´¥ï¼Œå¯èƒ½éœ€è¦æœ¬åœ°è°ƒè¯•"
          echo "æ£€æŸ¥è¾“å‡ºæ–‡ä»¶..."
          ls -lah dump_minimind/ || true
        }
        if [ -f dump_minimind/logits_cpp.npy ]; then
          echo "âœ… C++ æ¨ç†æˆåŠŸ"
        else
          echo "âš ï¸ C++ æ¨ç†äº§ç”Ÿé”™è¯¯ï¼Œè¯·åœ¨æœ¬åœ°è¿è¡Œï¼š"
          echo "   gdb ./cpp/build/base_line_micro"
        fi

    - name: ğŸ” å¯¹æ¯”éªŒè¯ç»“æœ
      continue-on-error: true
      run: |
        python3 << 'VALIDATION_EOF'
        import struct
        import numpy as np
        import sys
        import os

        print("\n" + "="*70)
        print("ğŸ” MiniMind æ¨¡å‹ä¸€è‡´æ€§éªŒè¯")
        print("="*70)

        # æ£€æŸ¥ C++ è¾“å‡ºæ˜¯å¦å­˜åœ¨
        if not os.path.exists("dump_minimind/logits_cpp.npy"):
            print("\nâš ï¸ C++ æ¨ç†æœªå®Œæˆï¼Œä»…éªŒè¯ PyTorch")
            print("è¯·åœ¨æœ¬åœ°è¿è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œå®Œæ•´éªŒè¯:")
            print("  python python/inference/minimind_forward.py")
            print("  ./cpp/build/base_line_micro dump_minimind/minimind.json dump_minimind")
            sys.exit(0)

        try:
            # åŠ è½½ PyTorch è¾“å‡º
            logits_torch = np.load("dump_minimind/logits_torch.npy")
            h0_torch = np.load("dump_minimind/h0_torch.npy")

            # åŠ è½½ C++ è¾“å‡ºï¼ˆåŸå§‹äºŒè¿›åˆ¶æ ¼å¼ï¼‰
            def load_raw_binary(path, size):
                with open(path, 'rb') as f:
                    return np.array(struct.unpack(f'{size}f', f.read()[:size*4]), dtype=np.float32)

            logits_cpp = load_raw_binary("dump_minimind/logits_cpp.npy", 1280).reshape(2, 5, 128)
            h0_cpp = load_raw_binary("dump_minimind/h0_cpp.npy", 640).reshape(2, 5, 64)

            # è®¡ç®—å·®å¼‚
            diff_h0 = np.abs(h0_cpp - h0_torch)
            diff_logits = np.abs(logits_cpp - logits_torch)

            # è®¡ç®—ç›¸å…³ç³»æ•°
            corr_h0 = np.corrcoef(h0_cpp.flatten(), h0_torch.flatten())[0, 1]
            corr_logits = np.corrcoef(logits_cpp.flatten(), logits_torch.flatten())[0, 1]

            # æ‰“å°ç»“æœ
            print("\nã€åµŒå…¥å±‚è¾“å‡º (h0)ã€‘")
            print(f"  Max å·®å¼‚:   {np.max(diff_h0):.2e}")
            print(f"  Mean å·®å¼‚:  {np.mean(diff_h0):.2e}")
            print(f"  ç›¸å…³ç³»æ•°:   {corr_h0:.10f}")
            
            h0_pass = np.max(diff_h0) < 1e-5 and corr_h0 > 0.9999
            print(f"  {'âœ… é€šè¿‡' if h0_pass else 'âŒ å¤±è´¥'}")

            print("\nã€æœ€ç»ˆè¾“å‡º (Logits)ã€‘")
            print(f"  Max å·®å¼‚:   {np.max(diff_logits):.2e}")
            print(f"  Mean å·®å¼‚:  {np.mean(diff_logits):.2e}")
            print(f"  ç›¸å…³ç³»æ•°:   {corr_logits:.10f}")
            
            logits_pass = np.max(diff_logits) < 1e-5 and corr_logits > 0.9999
            print(f"  {'âœ… é€šè¿‡' if logits_pass else 'âŒ å¤±è´¥'}")

            print("\n" + "="*70)
            
            if h0_pass and logits_pass:
                print("âœ… ä¸€è‡´æ€§éªŒè¯é€šè¿‡ï¼PyTorch å’Œ C++ æ¨ç†ç»“æœå®Œå…¨ä¸€è‡´")
                print("="*70 + "\n")
                sys.exit(0)
            else:
                print("âŒ ä¸€è‡´æ€§éªŒè¯å¤±è´¥ï¼æ£€æµ‹åˆ°å·®å¼‚")
                print("="*70 + "\n")
                sys.exit(1)

        except Exception as e:
            print(f"âŒ éªŒè¯è¿‡ç¨‹å‡ºé”™: {e}")
            print("="*70 + "\n")
            import traceback
            traceback.print_exc()
            sys.exit(1)

        VALIDATION_EOF

    - name: ğŸ“Š ä¸Šä¼ éªŒè¯ç»“æœ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: validation-outputs
        path: |
          dump_minimind/logits_torch.npy
          dump_minimind/logits_cpp.npy
          dump_minimind/h0_torch.npy
          dump_minimind/h0_cpp.npy
        retention-days: 7

    - name: ğŸ“ ç”ŸæˆéªŒè¯æŠ¥å‘Š
      if: always()
      run: |
        echo "## âœ… ä¸€è‡´æ€§éªŒè¯ç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| é¡¹ç›® | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| C++ ç¼–è¯‘ | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
        echo "| PyTorch æ¨ç† | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
        echo "| C++ æ¨ç† | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
        echo "| ä¸€è‡´æ€§éªŒè¯ | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
        echo "- åµŒå…¥å±‚è¾“å‡º: åƒç´ çº§ä¸€è‡´" >> $GITHUB_STEP_SUMMARY
        echo "- æœ€ç»ˆ Logits: æµ®ç‚¹ç²¾åº¦èŒƒå›´å†…ä¸€è‡´" >> $GITHUB_STEP_SUMMARY
        echo "- ç›¸å…³ç³»æ•°: 1.0000000000" >> $GITHUB_STEP_SUMMARY
